<ion-header translucent>
  <ion-toolbar>
    <ion-title>Profile</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content fullscreen class="profile-container">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <ion-spinner name="circles"></ion-spinner>
    <p>Loading your profile...</p>
  </div>

  <!-- Error State -->
  <ion-card *ngIf="error && !loading" class="error-card">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="alert-circle"></ion-icon>
        Error
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <p>{{ error }}</p>
    </ion-card-content>
  </ion-card>

  <!-- Profile Content -->
  <div *ngIf="!loading && !error && currentUser" class="profile-content">
    <!-- User Profile Header -->
    <div class="profile-header">
      <div class="avatar-container">
        <div class="avatar">{{ getAvatarInitials() }}</div>
      </div>
      <div class="user-info">
        <h2>{{ currentUser.displayName || 'Anonymous User' }}</h2>
        <p class="user-id">UID: {{ getShortenedUserId() }}</p>
      </div>
    </div>

    <!-- Statistics Section -->
    <div class="stats-section">
      <h3>Your Stats</h3>

      <!-- XP and Level Card -->
      <ion-card class="stat-card">
        <ion-card-content>
          <div class="stat-row">
            <div class="stat-item">
              <div class="stat-label">Level</div>
              <div class="stat-value">{{ userLevel }}</div>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
              <div class="stat-label">Total XP</div>
              <div class="stat-value">{{ currentUser.xp }}</div>
            </div>
          </div>

          <!-- XP Progress Bar -->
          <div class="progress-section">
            <div class="progress-label">{{ levelProgressText }}</div>
            <ion-progress-bar
              [value]="xpProgress.percent / 100"
              color="primary"
            ></ion-progress-bar>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Streaks Card -->
      <ion-card class="stat-card">
        <ion-card-content>
          <div class="stat-row">
            <div class="stat-item">
              <div class="stat-label">Current Streak</div>
              <div class="stat-value">
                {{ currentUser.currentStreak }}
                <span class="streak-emoji">{{ getStreakEmoji() }}</span>
              </div>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
              <div class="stat-label">Longest Streak</div>
              <div class="stat-value">{{ currentUser.longestStreak }}</div>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Lessons Card -->
      <ion-card class="stat-card">
        <ion-card-content>
          <div class="stat-label">Lessons Completed</div>
          <div class="stat-value-large">{{ currentUser.totalLessonsCompleted }}</div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Preferences Section -->
    <div class="preferences-section">
      <h3>Preferences</h3>

      <!-- Topics Card -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>Learning Topics</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div *ngIf="currentUser.selectedTopics.length > 0" class="topics-list">
            <ion-chip
              *ngFor="let topic of currentUser.selectedTopics"
              class="topic-chip"
            >
              {{ topic }}
            </ion-chip>
          </div>
          <p *ngIf="currentUser.selectedTopics.length === 0" class="empty-message">
            No topics selected yet
          </p>
          <ion-button
            expand="block"
            shape="round"
            color="secondary"
            (click)="editTopics()"
          >
            <ion-icon name="create" slot="start"></ion-icon>
            Edit Topics
          </ion-button>
        </ion-card-content>
      </ion-card>

      <!-- Notifications Card -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>Notifications</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-item lines="none">
            <ion-label>Enable Daily Reminders</ion-label>
            <ion-toggle
              slot="end"
              [checked]="currentUser.notificationsEnabled"
              (ionChange)="toggleNotifications()"
            ></ion-toggle>
          </ion-item>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Account Section -->
    <div class="account-section">
      <h3>Account</h3>

      <!-- Account Type Card -->
      <ion-card>
        <ion-card-content>
          <div class="account-info">
            <div class="info-row">
              <span class="info-label">Account Type:</span>
              <ion-badge *ngIf="currentUser.isAnonymous" color="warning">
                Anonymous
              </ion-badge>
              <ion-badge *ngIf="!currentUser.isAnonymous" color="success">
                Email
              </ion-badge>
            </div>
            <div class="info-row">
              <span class="info-label">Member Since:</span>
              <span>{{ getAccountCreatedDate() }}</span>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Sign Out Button -->
      <ion-button
        expand="block"
        shape="round"
        color="danger"
        (click)="signOut()"
        class="sign-out-button"
      >
        <ion-icon name="log-out" slot="start"></ion-icon>
        Sign Out
      </ion-button>
    </div>

    <!-- Spacing -->
    <div class="footer-spacing"></div>
  </div>
</ion-content>
